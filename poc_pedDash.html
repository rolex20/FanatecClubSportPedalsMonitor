<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PedMon Dashboard</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent-gas: #4caf50;
            --accent-gas-dim: #1b5e20;
            --accent-clutch: #2196f3;
            --accent-clutch-dim: #0d47a1;
            --accent-alert: #f44336;
            --accent-warn: #ff9800;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            background: #333;
            color: #aaa;
        }
        .status-badge.connected { background: var(--accent-gas-dim); color: #81c784; border: 1px solid var(--accent-gas); }
        .status-badge.disconnected { background: #3e1b1b; color: #e57373; border: 1px solid var(--accent-alert); }

        /* --- Main Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            flex: 1;
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        /* --- Pedal Gauges --- */
        .gauge-container {
            margin-bottom: 30px;
        }
        
        .gauge-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .gauge-values {
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .bar-track {
            height: 30px;
            background: #000;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }

        /* Physical Bar (Background, Dim) */
        .bar-fill-phys {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 0%;
            transition: width 0.05s linear;
            opacity: 0.3;
            z-index: 1;
        }

        /* Logical Bar (Foreground, Bright) */
        .bar-fill-log {
            position: absolute;
            top: 6px; left: 0; bottom: 6px; /* Slightly narrower */
            width: 0%;
            transition: width 0.05s linear;
            z-index: 2;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border-radius: 0 2px 2px 0;
        }

        /* Gas Colors */
        .gas .bar-fill-phys { background-color: var(--accent-gas); }
        .gas .bar-fill-log { background-color: var(--accent-gas); }
        
        /* Clutch Colors */
        .clutch .bar-fill-phys { background-color: var(--accent-clutch); }
        .clutch .bar-fill-log { background-color: var(--accent-clutch); }

        /* --- Metrics Grid --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .metric-box {
            background: #252525;
            padding: 10px;
            border-radius: 4px;
        }
        .metric-label { font-size: 0.75rem; color: var(--text-dim); }
        .metric-value { font-size: 1.1rem; font-family: 'Consolas', monospace; margin-top: 4px; }

        /* --- Event Log --- */
        #eventLog {
            flex: 1;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            border-top: 1px solid #333;
            margin-top: 10px;
            padding-top: 10px;
        }
        .log-entry { margin-bottom: 4px; border-left: 3px solid #555; padding-left: 8px; }
        .log-entry.gas-alert { border-color: var(--accent-warn); color: var(--accent-warn); }
        .log-entry.rudder-alert { border-color: var(--accent-alert); color: var(--accent-alert); }
        .log-entry.system { border-color: var(--accent-clutch); color: var(--text-dim); }
        .log-entry span { color: #555; margin-right: 8px; }

    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h1>PED<span style="color:var(--accent-gas)">MON</span> DASHBOARD</h1>
            <div id="connectionStatus" class="status-badge disconnected">OFFLINE</div>
        </div>
        <div style="text-align:right; font-size:0.8rem; color:var(--text-dim);">
            <div id="bridgeTime">Bridge: --</div>
            <div id="pedMonTime">PedMon: --</div>
        </div>
    </header>

    <div class="dashboard-grid">
        <!-- LEFT: Visuals -->
        <div class="panel">
            <div class="panel-header">
                <span>Live Telemetry</span>
                <span id="controllerId">No Device</span>
            </div>

            <!-- Gas Gauge -->
            <div class="gauge-container gas">
                <div class="gauge-label">
                    <span>GAS</span>
                    <span class="gauge-values">
                        P:<span id="valGasPhys">0</span>% 
                        L:<span id="valGasLog">0</span>% 
                        Raw:<span id="valGasRaw">0</span>
                    </span>
                </div>
                <div class="bar-track">
                    <div id="barGasPhys" class="bar-fill-phys"></div>
                    <div id="barGasLog" class="bar-fill-log"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#555; margin-top:2px;">
                    <span>Idle Deadzone</span>
                    <span>Full Throttle</span>
                </div>
            </div>

            <!-- Clutch Gauge -->
            <div class="gauge-container clutch">
                <div class="gauge-label">
                    <span>CLUTCH / RUDDER</span>
                    <span class="gauge-values">
                        P:<span id="valClutchPhys">0</span>% 
                        L:<span id="valClutchLog">0</span>%
                        Raw:<span id="valClutchRaw">0</span>
                    </span>
                </div>
                <div class="bar-track">
                    <div id="barClutchPhys" class="bar-fill-phys"></div>
                    <div id="barClutchLog" class="bar-fill-log"></div>
                </div>
            </div>

            <!-- Advanced Metrics -->
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-label">Loop Time</div>
                    <div class="metric-value"><span id="metricLoop">0</span> ms</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Est. Deadzone Out</div>
                    <div class="metric-value"><span id="metricEst">--</span> %</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Packets / Seq</div>
                    <div class="metric-value"><span id="metricSeq">0</span></div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Bridge Lag</div>
                    <div class="metric-value"><span id="metricLag">0</span> ms</div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Events & Config -->
        <div class="panel">
            <div class="panel-header">
                <span>Event Log</span>
                <button onclick="clearLog()" style="background:none; border:none; color:#555; cursor:pointer;">Clear</button>
            </div>
            <div id="eventLog">
                <div class="log-entry system">Waiting for data...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8181/json';
        const POLL_INTERVAL_MS = 60; // ~16fps UI updates, good enough for dash

        let lastSeq = -1;
        let isConnected = false;

        // Elements
        const elStatus = document.getElementById('connectionStatus');
        const elBridgeTime = document.getElementById('bridgeTime');
        const elPedMonTime = document.getElementById('pedMonTime');
        const elController = document.getElementById('controllerId');
        
        // Bars
        const barGasPhys = document.getElementById('barGasPhys');
        const barGasLog = document.getElementById('barGasLog');
        const barClutchPhys = document.getElementById('barClutchPhys');
        const barClutchLog = document.getElementById('barClutchLog');

        // Text Values
        const valGasPhys = document.getElementById('valGasPhys');
        const valGasLog = document.getElementById('valGasLog');
        const valGasRaw = document.getElementById('valGasRaw');
        const valClutchPhys = document.getElementById('valClutchPhys');
        const valClutchLog = document.getElementById('valClutchLog');
        const valClutchRaw = document.getElementById('valClutchRaw');

        // Metrics
        const mLoop = document.getElementById('metricLoop');
        const mEst = document.getElementById('metricEst');
        const mSeq = document.getElementById('metricSeq');
        const mLag = document.getElementById('metricLag');

        // Log
        const eventLog = document.getElementById('eventLog');

        function updateUI(frame, bridgeInfo) {
            // 1. Connection State
            if (!isConnected) {
                isConnected = true;
                elStatus.textContent = "CONNECTED";
                elStatus.className = "status-badge connected";
                log("System", "Connected to Bridge.");
            }

            // 2. Controller Info
            if (frame.controller.connected) {
                elController.textContent = `ID ${frame.controller.joyId} (VID:${frame.controller.vendorId})`;
            } else {
                elController.textContent = "DISCONNECTED";
                elController.style.color = "var(--accent-alert)";
            }

            // 3. Timestamps & Lag
            const now = Date.now();
            const bridgeLag = now - bridgeInfo.servedAtUnixMs;
            elBridgeTime.textContent = `Bridge: ${new Date(bridgeInfo.servedAtUnixMs).toLocaleTimeString()}`;
            elPedMonTime.textContent = `PedMon: ${frame.pedMonTimeMs}`; // Raw ticks
            mLag.textContent = bridgeLag;
            mSeq.textContent = frame.seq;
            mLoop.textContent = frame.telemetry.fullLoopTimeMs;

            // 4. Pedals (Using the NEW precomputed PCT fields)
            updateBar(barGasPhys, valGasPhys, frame.pedals.gasPhysicalPct);
            updateBar(barGasLog, valGasLog, frame.pedals.gasLogicalPct);
            valGasRaw.textContent = frame.pedals.rawGas;

            updateBar(barClutchPhys, valClutchPhys, frame.pedals.clutchPhysicalPct);
            updateBar(barClutchLog, valClutchLog, frame.pedals.clutchLogicalPct);
            valClutchRaw.textContent = frame.pedals.rawClutch;

            // 5. Estimation
            // (Assuming best_estimate_percent is available in frame.estimator or similar location in JSON)
            // Note: In the PS script provided, this was likely flattened or in a specific sub-object.
            // Based on previous JSON structure: frame.events.estimateChanged? No, value is in struct.
            // Let's assume it's exposed. If not, placeholder.
            // Looking at PS script: $data.best_estimate_percent wasn't explicitly in the JSON 'pedals' or 'telemetry' block
            // in my last response. 
            // *Self-Correction*: The PS script in the previous turn *did not* map 'best_estimate_percent' to the JSON output explicitly 
            // except in TTS messages. 
            // However, for this PoC dash, we'll check if it exists or default.
            if(frame.estimator && frame.estimator.bestEstimate) {
                mEst.textContent = frame.estimator.bestEstimate;
            } else {
                mEst.textContent = "--";
            }

            // 6. Events
            handleEvents(frame);
        }

        function updateBar(barEl, textEl, pct) {
            barEl.style.width = `${pct}%`;
            textEl.textContent = pct;
        }

        function handleEvents(frame) {
            // Only log if sequence changed (avoid spamming log for same frame)
            if (frame.seq === lastSeq) return;
            lastSeq = frame.seq;

            if (frame.events.gasAlert) log("GAS", "Drift Detected!", "gas-alert");
            if (frame.events.clutchAlert) log("RUDDER", "Noise Detected!", "rudder-alert");
            if (frame.events.reconnected) log("SYS", "Controller Reconnected", "system");
            if (frame.events.estimateDown) log("INFO", "Deadzone Estimate Lowered", "system");
            if (frame.events.autoAdjusted) log("AUTO", "Deadzone Adjusted", "system");
        }

        function log(type, msg, className="system") {
            const div = document.createElement('div');
            div.className = `log-entry ${className}`;
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.innerHTML = `<span>[${time}] ${type}</span> ${msg}`;
            eventLog.prepend(div);
            // Limit log size
            if (eventLog.children.length > 50) eventLog.lastChild.remove();
        }

        function clearLog() {
            eventLog.innerHTML = '<div class="log-entry system">Log cleared.</div>';
        }

        async function loop() {
            try {
                // Add random cache buster just in case
                const res = await fetch(`${API_URL}?_=${Date.now()}`);
                if (!res.ok) throw new Error("Bridge error");
                
                const data = await res.json();
                
                if (data.frames && data.frames.length > 0) {
                    // Visualize the latest frame
                    const latestFrame = data.frames[data.frames.length - 1];
                    updateUI(latestFrame, data.bridgeInfo);
                }

            } catch (err) {
                console.error(err);
                if (isConnected) {
                    isConnected = false;
                    elStatus.textContent = "OFFLINE";
                    elStatus.className = "status-badge disconnected";
                    log("System", "Connection lost to PedBridge.");
                }
            }
            
            setTimeout(loop, POLL_INTERVAL_MS);
        }

        // Start
        loop();

    </script>
</body>
</html>